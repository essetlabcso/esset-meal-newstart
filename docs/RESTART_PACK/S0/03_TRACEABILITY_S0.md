# S0 Traceability Matrix (A2 Seed)

Canonical source: `docs/enhanced_master_spec_v0_1_18012026.md` (read-only)

| Feature/Rule ID | Spec section | Entities | API/Server module | UI surface | Tests | Gate proof | Status | Notes |
|---|---|---|---|---|---|---|---|---|
| TOC-UX-01 | 5.1 Tri-state UX modes | `toc_versions`, `toc_nodes`, `toc_edges` | `src/app/app/projects/[projectId]/toc/actions.ts` (`createDraftVersionAction`, `upsertDraftNodeAction`, `addDraftEdgeAction`, `readDraftPayloadAction`) | `src/app/app/projects/[projectId]/toc/page.tsx`, `src/app/app/projects/[projectId]/toc/TocGraphClient.tsx` | `tests/gate23_toc_publish.e2e.spec.ts`, `supabase/tests/s0_toc_draft_crud_scope.sql` | `docs/PHASE_S0_PROOF_PACK.md` | Partial / Proof Blocked | C1 server-side draft CRUD/read payload actions added; full runtime proof still environment-blocked. |
| TOC-UX-02 | 5.1.1 Wizard mode friction bump | `toc_nodes`, `toc_edges` | `src/app/app/projects/[projectId]/toc/actions.ts` | `src/app/app/projects/[projectId]/toc/page.tsx` | N/A | `docs/PHASE_S0_PROOF_PACK.md` | Pending | Explicit Add New vs Link Existing UX contract is only partially enforced. |
| TOC-MP-01 | 5.2 Multi-parenting: Primary Parent Rule | `toc_nodes` (`primary_parent_id`) | `supabase/migrations/20260218020000_s0_canonical_slice.sql`, `supabase/migrations/20260218113000_phase_e_projection_matrix_read_model.sql`, `src/app/app/projects/[projectId]/toc/actions.ts` (`upsertDraftNodeAction`) | `src/app/app/projects/[projectId]/toc/page.tsx` | `tests/unit/projectionContract.test.mjs`, `supabase/tests/s0_toc_projection_contract.sql` | `tests/unit/projectionContract.test.mjs` | Implemented / Unit-Proven | Server action enforces GOAL/no-parent and same-draft parent scoping. |
| TOC-MP-02 | 5.2 Multi-parenting: Secondary links | `toc_edges` (`edge_kind=secondary_link`), derived matrix rows (`row_kind='ghost_secondary'`) | `supabase/migrations/20260218113000_phase_e_projection_matrix_read_model.sql`, `src/app/app/projects/[projectId]/toc/actions.ts` (`addDraftEdgeAction`, `readDraftPayloadAction`) | `src/app/app/projects/[projectId]/toc/page.tsx` | `tests/unit/projectionContract.test.mjs`, `supabase/tests/s0_toc_projection_contract.sql` | `tests/unit/projectionContract.test.mjs` | Implemented / Unit-Proven | Edge action supports `causal/secondary_link/feedback`; projection marks secondary links as ghost rows. |
| TOC-MP-03 | 5.2 Multi-parenting: Rehome is explicit | `toc_nodes` (`primary_parent_id`), audit surface | N/A | N/A | N/A | `docs/PHASE_S0_PROOF_PACK.md` | Pending | Explicit rehome confirmation/audit action is not fully wired as a dedicated flow yet. |
| TOC-PROJ-01 | 5.4 Projection algorithm: primary path key generation | `toc_nodes.primary_parent_id`, `toc_nodes.created_at`, `toc_nodes.id` | `supabase/migrations/20260218113000_phase_e_projection_matrix_read_model.sql` (`read_toc_projection_matrix`), `src/lib/toc/projectionContract.mjs` (`buildProjectionRows`) | `src/app/app/projects/[projectId]/toc/page.tsx` | `tests/unit/projectionContract.test.mjs`, `supabase/tests/s0_toc_projection_contract.sql` | `tests/unit/projectionContract.test.mjs` | Implemented / Unit-Proven | Primary lineage keys are computed deterministically with explicit `created_at,id` tie-breakers. |
| TOC-PROJ-02 | 5.4 Projection algorithm: ghost row generation | `toc_edges.edge_kind`, derived matrix rows (`row_kind='ghost_secondary'`) | `supabase/migrations/20260218113000_phase_e_projection_matrix_read_model.sql`, `src/lib/toc/projectionContract.mjs` | `src/app/app/projects/[projectId]/toc/page.tsx` | `tests/unit/projectionContract.test.mjs`, `supabase/tests/s0_toc_projection_contract.sql` | `tests/unit/projectionContract.test.mjs` | Implemented / Unit-Proven | Ghost rows are generated only from `edge_kind='secondary_link'` links. |
| TOC-PROJ-03 | 5.4 Projection algorithm: content not duplicated | derived read-model joins (`node_id` + node fields), `toc_nodes` | `supabase/migrations/20260218113000_phase_e_projection_matrix_read_model.sql`, `src/app/app/projects/[projectId]/toc/actions.ts` (`readDraftPayloadAction`) | `src/app/app/projects/[projectId]/toc/page.tsx` | `tests/unit/projectionContract.test.mjs`, `supabase/tests/s0_toc_projection_contract.sql` | `tests/unit/projectionContract.test.mjs` | Implemented / Unit-Proven | Matrix payload includes read-model content fields (`node_title`, `node_description`, `node_narrative`) keyed by `node_id`. |
| TOC-PROJ-04 | 5.4 Projection algorithm: deterministic ordering | derived `path_sort_key`, `row_kind`, parent IDs, edge tie-breakers | `supabase/migrations/20260218113000_phase_e_projection_matrix_read_model.sql`, `src/lib/toc/projectionContract.mjs`, `src/app/app/projects/[projectId]/toc/actions.ts` | `src/app/app/projects/[projectId]/toc/page.tsx` | `tests/unit/projectionContract.test.mjs`, `supabase/tests/s0_toc_projection_contract.sql` | `tests/unit/projectionContract.test.mjs` | Implemented / Unit-Proven | Matrix ordering now mirrors DB ordering keys, including deterministic null UUID tie-break handling. |
| TOC-PUB-01 | 5.5 Publish lifecycle: atomic + snapshot binding | `toc_versions`, `analysis_snapshots` | `src/lib/toc/publishService.mjs`, `src/app/app/projects/[projectId]/toc/actions.ts` (`publishToc`), `supabase/migrations/20260218070000_s0_publish_atomic_rpc.sql` (`publish_toc_version_atomic`) | `src/app/app/projects/[projectId]/toc/page.tsx` | `tests/unit/publishService.test.mjs`, `supabase/tests/s0_publish_atomic_transaction.sql` | `supabase/tests/s0_publish_atomic_transaction.sql` | Implemented / Proof Blocked | Gate A validated in app service; snapshot freeze + publish + new draft executed atomically in RPC. |
| TOC-PUB-02 | 5.5 Publish lifecycle: immutability after publish | `toc_versions`, `toc_nodes`, `toc_edges` | `supabase/migrations/20260217093000_gate23_toc_gate_a_publish_cow.sql`, `supabase/migrations/20260218040000_s0_schema_minimum_alignment.sql`, `supabase/migrations/20260218070000_s0_publish_atomic_rpc.sql` | `src/app/app/projects/[projectId]/toc/page.tsx` | `supabase/tests/toc_gate_a_publish.sql`, `supabase/tests/s0_publish_atomic_transaction.sql`, `tests/gate23_toc_publish.e2e.spec.ts` | `supabase/tests/s0_publish_atomic_transaction.sql` | Implemented / Proof Blocked | Published rows become immutable; edits continue only on the spawned DRAFT copy. |
| SNAP-01 | 4.3 Analysis Snapshot entity | `analysis_snapshots`, `toc_versions.linked_analysis_snapshot_id` | `supabase/migrations/20260218040000_s0_schema_minimum_alignment.sql`, `supabase/migrations/20260218070000_s0_publish_atomic_rpc.sql` | `src/app/app/projects/[projectId]/toc/page.tsx` | `supabase/tests/s0_publish_atomic_transaction.sql`, `supabase/tests/s0_export_manifest_hash.sql` | `supabase/tests/s0_publish_atomic_transaction.sql` | Implemented / Proof Blocked | Publish creates immutable freeze snapshot and binds it on published ToC version. |
| GA-01 | 6.2 Gate A MUST rules | `toc_nodes` | `supabase/migrations/20260218020000_s0_canonical_slice.sql` (`validate_gate_a`) | `src/app/app/projects/[projectId]/toc/page.tsx` | `supabase/tests/s0_toc_gate_a_full.sql` | `supabase/tests/s0_toc_gate_a_full.sql` | Implemented / Proof Blocked | Deterministic code: `GA_ERR_GOAL_COUNT`. |
| GA-02 | 6.2 Gate A MUST rules | `toc_nodes` (`primary_parent_id`) | `supabase/migrations/20260218020000_s0_canonical_slice.sql` | `src/app/app/projects/[projectId]/toc/page.tsx` | `supabase/tests/s0_toc_gate_a_full.sql`, `supabase/tests/toc_gate_a_publish.sql` | `supabase/tests/s0_toc_gate_a_full.sql` | Implemented / Proof Blocked | Deterministic code: `GA_ERR_ORPHANS`. |
| GA-03 | 6.2 Gate A MUST rules | `toc_nodes` type hierarchy | `supabase/migrations/20260218020000_s0_canonical_slice.sql` | `src/app/app/projects/[projectId]/toc/page.tsx` | `supabase/tests/s0_toc_gate_a_full.sql` | `supabase/tests/s0_toc_gate_a_full.sql` | Implemented / Proof Blocked | Deterministic code: `GA_ERR_TYPE_CHAIN`. |
| GA-04 | 6.2 Gate A MUST rules | `toc_edges` causal graph | `supabase/migrations/20260218020000_s0_canonical_slice.sql` | `src/app/app/projects/[projectId]/toc/page.tsx` | `supabase/tests/s0_toc_gate_a_full.sql` | `supabase/tests/s0_toc_gate_a_full.sql` | Implemented / Proof Blocked | Deterministic code: `GA_ERR_CAUSAL_CYCLE`; feedback excluded. |
| GA-05 | 6.2 Gate A MUST rules | `toc_edges` uniqueness | `supabase/migrations/20260218020000_s0_canonical_slice.sql` (unique index) | N/A | `supabase/tests/s0_toc_gate_a_full.sql` | `supabase/tests/s0_toc_gate_a_full.sql` | Implemented / Proof Blocked | Deterministic code: `GA_ERR_DUP_EDGE`. |
| GA-06 | 6.2 Gate A MUST rules | `toc_edges.mechanism` | `supabase/migrations/20260218020000_s0_canonical_slice.sql` | `src/app/app/projects/[projectId]/toc/page.tsx` | `supabase/tests/s0_toc_gate_a_full.sql` | `supabase/tests/s0_toc_gate_a_full.sql` | Implemented / Proof Blocked | Deterministic code: `GA_ERR_EDGE_MECH`. |
| GA-07 | 6.2 Gate A MUST rules | `toc_edges.confidence`, `toc_edges.risk_flag`, `sentinel_indicator_id` | `supabase/migrations/20260218020000_s0_canonical_slice.sql` | N/A | `supabase/tests/s0_toc_gate_a_full.sql` | `supabase/tests/s0_toc_gate_a_full.sql` | Implemented / Proof Blocked | Deterministic code: `GA_ERR_SENTINEL`. |
| GA-08 | 6.2 Gate A MUST rules | RLS-required tables + policies | `supabase/migrations/20260218020000_s0_canonical_slice.sql` (`ga_rls_baseline_ok`) | N/A | `supabase/tests/s0_toc_gate_a_full.sql` | `supabase/tests/s0_toc_gate_a_full.sql` | Implemented / Proof Blocked | Deterministic code: `GA_ERR_RLS_BASELINE`. |
| SEC-03 | 8.1 Tenant isolation: Invisible Wall | RLS on tenant-scoped tables | `supabase/migrations/20260215184100_gate5_1_hardening.sql`, `supabase/migrations/20260215184200_gate5_1a_fix_rls_qual.sql` | `src/app/app/projects/[projectId]/page.tsx` | `supabase/tests/toc_rls_zero_rows.sql`, `supabase/tests/s0_sec_stop_ship.sql` | `supabase/tests/s0_sec_stop_ship.sql` | Implemented / Proof Blocked | DB proof blocked by missing Docker engine. |
| SEC-04 | 8.1 Response silence | Query/result behavior under unauthorized context | `supabase/migrations/20260215184100_gate5_1_hardening.sql` | `src/app/app/projects/[projectId]/page.tsx` | `tests/gate22_wks_prj_context.e2e.spec.ts` | `tests/gate22_wks_prj_context.e2e.spec.ts` | Implemented / Proof Blocked | E2E is skipped when auth env vars are missing. |
| SEC-TEST-01 | 8.2 Stop-ship negative tests | Cross-tenant project/toc reads | `supabase/tests/toc_rls_zero_rows.sql`, `supabase/tests/s0_sec_stop_ship.sql`, `supabase/tests/s0_toc_draft_crud_scope.sql` | `src/app/app/projects/[projectId]/page.tsx` | `supabase/tests/toc_rls_zero_rows.sql`, `supabase/tests/s0_sec_stop_ship.sql`, `supabase/tests/s0_toc_draft_crud_scope.sql`, `tests/gate22_wks_prj_context.e2e.spec.ts` | `supabase/tests/s0_sec_stop_ship.sql`, `supabase/tests/s0_toc_draft_crud_scope.sql` | Implemented / Proof Blocked | Added C1 draft CRUD scope proof for 0-row cross-tenant reads. |
| SEC-TEST-02 | 8.2 Stop-ship negative tests | Cross-tenant write rejection | `supabase/tests/s0_sec_stop_ship.sql`, `supabase/tests/s0_toc_draft_crud_scope.sql` | N/A | `supabase/tests/s0_sec_stop_ship.sql`, `supabase/tests/s0_toc_draft_crud_scope.sql` | `supabase/tests/s0_sec_stop_ship.sql`, `supabase/tests/s0_toc_draft_crud_scope.sql` | Implemented / Proof Blocked | C1 test asserts published-version writes are no-op (`row_count=0`). |
| SEC-TEST-03 | 8.2 Stop-ship negative tests | Client bundle/service-role exposure scan | `scripts/s0_spec_drift_check.mjs`, `.github/workflows/s0_drift_guard.yml` | N/A | `node scripts/s0_spec_drift_check.mjs` | `node scripts/s0_spec_drift_check.mjs` | Runtime-Proven | Last run: `S0_DRIFT_PASS`. |
| RPT-01 | 4.5 Reporting manifest | `report_manifests` | `supabase/migrations/20260218020000_s0_canonical_slice.sql` (`export_matrix_csv`) | `src/app/app/projects/[projectId]/toc/page.tsx` | `supabase/tests/s0_export_manifest_hash.sql` | `supabase/tests/s0_export_manifest_hash.sql` | Implemented / Proof Blocked | Deterministic hash + manifest persistence scripted. |
| RPT-02 | 7.3 Snapshot-bound reporting | `toc_versions.linked_analysis_snapshot_id`, `report_manifests` | `supabase/migrations/20260218020000_s0_canonical_slice.sql`, `src/app/app/projects/[projectId]/toc/actions.ts` | `src/app/app/projects/[projectId]/toc/page.tsx` | `supabase/tests/s0_export_manifest_hash.sql`, `tests/s0_export_auth.e2e.spec.ts` | `supabase/tests/s0_export_manifest_hash.sql` | Implemented / Proof Blocked | Export bound to published version + linked snapshot. |
| AN-01 | 10.1 Contribution mode | Export allocation mode contract | `supabase/migrations/20260218020000_s0_canonical_slice.sql` | N/A | `supabase/tests/s0_export_manifest_hash.sql`, `node scripts/s0_spec_drift_check.mjs` | `supabase/tests/s0_export_manifest_hash.sql` | Implemented / Proof Blocked | Weighted allocation explicitly rejected. |
| AN-02 | 10.1 Contribution mode | De-dup by GUID in projection/export | `supabase/migrations/20260218020000_s0_canonical_slice.sql` | N/A | `supabase/tests/s0_export_manifest_hash.sql` | `supabase/tests/s0_export_manifest_hash.sql` | Implemented / Proof Blocked | Runtime SQL proof blocked. |
| AN-03 | 10.1 Contribution mode | Reconciliation footnotes in export | `supabase/migrations/20260218020000_s0_canonical_slice.sql` | `src/app/app/projects/[projectId]/toc/page.tsx` | `supabase/tests/s0_export_manifest_hash.sql` | `supabase/tests/s0_export_manifest_hash.sql` | Implemented / Proof Blocked | Footnote output exists in export builder path. |

## Exact Entity/Table -> Migration Map (S0 Schema)
| Entity/Table | Exact schema elements | Implementing migration file(s) |
|---|---|---|
| `public.toc_versions` | `id`, `tenant_id`, `project_id`, `analysis_snapshot_id`, `linked_analysis_snapshot_id`, `status`, `version_number`, `version_label`, `source_version_id`, `published_at`, `created_by`, `created_at` | `supabase/migrations/20260215061500_gate5_toc_graph.sql`, `supabase/migrations/20260217093000_gate23_toc_gate_a_publish_cow.sql`, `supabase/migrations/20260218020000_s0_canonical_slice.sql`, `supabase/migrations/20260218040000_s0_schema_minimum_alignment.sql` |
| `public.toc_nodes` | `id`, `tenant_id`, `toc_version_id`, `node_type`, `title`, `description`, `narrative`, `primary_parent_id`, `primary_path_key`, `metadata`, `created_by`, `created_at`, `updated_at` | `supabase/migrations/20260215061500_gate5_toc_graph.sql`, `supabase/migrations/20260217093000_gate23_toc_gate_a_publish_cow.sql`, `supabase/migrations/20260218020000_s0_canonical_slice.sql`, `supabase/migrations/20260218040000_s0_schema_minimum_alignment.sql` |
| `public.toc_edges` | `id`, `tenant_id`, `toc_version_id`, `source_node_id`, `target_node_id`, `edge_type`, `edge_kind`, `mechanism`, `confidence`, `risk_flag`, `sentinel_indicator_id`, `created_by`, `created_at`, `updated_at`; unique index on `(toc_version_id, source_node_id, target_node_id, edge_kind)` | `supabase/migrations/20260215061500_gate5_toc_graph.sql`, `supabase/migrations/20260217093000_gate23_toc_gate_a_publish_cow.sql`, `supabase/migrations/20260218020000_s0_canonical_slice.sql` |
| `public.analysis_snapshots` | `id`, `tenant_id`, `project_id`, `title`, `snapshot`, `captured_at`, `source`, `created_by`, `created_at` | `supabase/migrations/20260215061500_gate5_toc_graph.sql`, `supabase/migrations/20260218040000_s0_schema_minimum_alignment.sql` |
| `public.toc_projections` | `id`, `tenant_id`, `project_id`, `toc_version_id`, `node_id`, `path_key`, `is_ghost`, `source_edge_id`, `created_by`, `created_at` | `supabase/migrations/20260218020000_s0_canonical_slice.sql` |
| `public.read_toc_projection_matrix(_tenant_id,_project_id,_toc_version_id)` | Derived projection rows: `node_id`, `primary_path_key`, `path_key`, `path_sort_key`, `row_kind`, `source_edge_id`, `projection_parent_id`, `goal_id`, `outcome_id`, `output_id`, `depth`, plus joined node display fields | `supabase/migrations/20260218113000_phase_e_projection_matrix_read_model.sql` |
| `public.report_manifests` | `id`, `tenant_id`, `project_id`, `toc_version_id`, `analysis_snapshot_id`, `time_window`, `export_type`, `config_json`, `hash`, `artifact_csv`, `created_by`, `created_at` | `supabase/migrations/20260218020000_s0_canonical_slice.sql`, `supabase/migrations/20260218113000_phase_e_projection_matrix_read_model.sql` |
| `public.toc_versions` immutability policy | Update/delete allowed only when `status='DRAFT'` for authenticated org admins | `supabase/migrations/20260218040000_s0_schema_minimum_alignment.sql` |

## Current Runtime Snapshot
- Verdict: **NO-GO**
- Blockers:
  - Docker engine unavailable (`dockerDesktopLinuxEngine` not found).
  - Missing auth runtime env vars (`NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`).
